{% extends "base.html" %}
{% block title %}Comments{% endblock %}

{% block content %}
<div class="container my-4">
  <!-- Back to posts -->
  <a href="{% url 'tweet_list' %}" class="btn btn-sm btn-secondary mb-3">← Back to Posts</a>

  <h3>Comments on {{ tweet.user.username }}’s Post</h3>
  <div class="col d-flex justify-content-center mb-3">
  <div class="card p-3" style="width: 20rem">
    {% if tweet.image %}
      <img src="{{ tweet.image.url }}" class="card-img-top" style="height:200px;object-fit:cover;">
    {% endif %}
    <div class="card-body">
      <p class="card-text">{{ tweet.content }}</p>
    </div>
  </div>
  </div>

  <div id="comments-list">
    {% for c in comments %}
      <div class="rounded border p-2 mb-2" id="comment-{{ c.id }}">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <strong>{{ c.user.username }}</strong>
            <small class="text-muted">{{ c.created_at|date:"M j, H:i" }}</small>
          </div>
          {% if c.user == request.user %}
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-info edit-btn" data-id="{{ c.id }}">Edit</button>
            <button class="btn btn-outline-danger delete-btn" data-id="{{ c.id }}">Delete</button>
          </div>
          {% endif %}
        </div>
        <p class="content mt-2">{{ c.content }}</p>
      </div>
    {% empty %}
      <p>No comments yet.</p>
    {% endfor %}
  </div>
</div>

<script>
// --- CSRF helper ---
function getCookie(name) {
  let cookieValue = null;
  document.cookie.split(';').forEach(c => {
    c = c.trim();
    if (c.startsWith(name + '=')) {
      cookieValue = decodeURIComponent(c.slice(name.length + 1));
    }
  });
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// --- Edit comment handler ---
document.querySelectorAll('.edit-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const id        = btn.dataset.id;
    const container = document.getElementById(`comment-${id}`);
    const p         = container.querySelector('.content');
    const origText  = p.textContent.trim();

    // Hide the paragraph and disable the edit button
    p.style.display = 'none';
    btn.disabled    = true;

    // Create an inline edit form
    const form = document.createElement('form');
    form.className = 'd-flex mb-2';
    form.innerHTML = `
      <input type="text" name="content"
             class="form-control form-control-sm me-2"
             value="${origText.replace(/"/g, '&quot;')}" required>
      <button type="submit" class="btn btn-sm btn-success me-1">Save</button>
      <button type="button" class="btn btn-sm btn-secondary cancel-btn">Cancel</button>
    `;
    container.appendChild(form);

    // Cancel handler
    form.querySelector('.cancel-btn').addEventListener('click', () => {
      form.remove();
      p.style.display = '';
      btn.disabled    = false;
    });

    // Save handler
    form.addEventListener('submit', e => {
      e.preventDefault();
      const newText = form.querySelector('input[name="content"]').value.trim();
      if (!newText) return alert('Comment cannot be empty.');

      fetch(`/comment-edit/${id}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ content: newText })
      })
      .then(res => res.json())
      .then(data => {
        if (data.content) {
          p.textContent    = data.content;
          form.remove();
          p.style.display  = '';
          btn.disabled     = false;
        } else {
          alert('Error: ' + JSON.stringify(data.errors));
        }
      })
      .catch(console.error);
    });
  });
});

// --- Delete comment handler ---
document.querySelectorAll('.delete-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    if (!confirm('Delete this comment?')) return;
    const id = btn.dataset.id;
    fetch(`/comment-delete/${id}/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken }
    })
    .then(res => res.json())
    .then(data => {
      if (data.deleted) {
        document.getElementById(`comment-${id}`).remove();
      } else {
        alert('Failed to delete comment.');
      }
    })
    .catch(console.error);
  });
});
</script>

{% endblock %}
